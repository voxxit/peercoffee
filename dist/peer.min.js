/*! peerjs build: 0.3.9 - Copyright(c) 2013 Michelle Bu <michelle@michellebu.com> */
function BufferBuilder(){this._pieces=[],this._parts=[]}function Unpacker(a){this.index=0,this.dataBuffer=a,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function Packer(){this.bufferBuilder=new BufferBuilder}function EventEmitter(){this._events={}}function Reliable(a,b){return this instanceof Reliable?(this._dc=a,util.debug=b,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new Reliable(a)}function Peer(a,b){return this instanceof Peer?(EventEmitter.call(this),a&&a.constructor==Object?(b=a,a=void 0):a&&(a=a.toString()),b=util.extend({debug:0,host:util.CLOUD_HOST,port:util.CLOUD_PORT,key:"peerjs",path:"/",token:util.randomToken(),config:util.defaultConfig},b),this.options=b,"/"===b.host&&(b.host=window.location.hostname),"/"!==b.path[0]&&(b.path="/"+b.path),"/"!==b.path[b.path.length-1]&&(b.path+="/"),void 0===b.secure&&b.host!==util.CLOUD_HOST&&(b.secure=util.isSecure()),b.logFunction&&util.setLogFunction(b.logFunction),util.setLogLevel(b.debug),util.supports.audioVideo||util.supports.data?util.validateId(a)?util.validateKey(b.key)?b.secure&&"0.peerjs.com"===b.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(a?this._initialize(a):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+b.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+a+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new Peer(a,b)}function DataConnection(a,b,c){return this instanceof DataConnection?(EventEmitter.call(this),this.options=util.extend({serialization:"binary",reliable:!1},c),this.open=!1,this.type="data",this.peer=a,this.provider=b,this.id=this.options.connectionId||DataConnection._idPrefix+util.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void Negotiator.startConnection(this,this.options._payload||{originator:!0})):new DataConnection(a,b,c)}function MediaConnection(a,b,c){return this instanceof MediaConnection?(EventEmitter.call(this),this.options=util.extend({},c),this.open=!1,this.type="media",this.peer=a,this.provider=b,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||MediaConnection._idPrefix+util.randomToken(),void(this.localStream&&Negotiator.startConnection(this,{_stream:this.localStream,originator:!0}))):new MediaConnection(a,b,c)}function Socket(a,b,c,d,e){if(!(this instanceof Socket))return new Socket(a,b,c,d,e);EventEmitter.call(this),this.disconnected=!1,this._queue=[];var f=a?"https://":"http://",g=a?"wss://":"ws://";this._httpUrl=f+b+":"+c+d+e,this._wsUrl=g+b+":"+c+d+"peerjs?key="+e}var binaryFeatures={};binaryFeatures.useBlobBuilder=function(){try{return new Blob([]),!1}catch(a){return!0}}(),binaryFeatures.useArrayBufferView=!binaryFeatures.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(a){return!0}}(),binaryFeatures.supportsBinaryWebsockets=function(){try{var a=new WebSocket("ws://null");return a.onerror=function(){},"undefined"!=typeof a.binaryType?!0:!1}catch(b){return!1}}(),exports.binaryFeatures=binaryFeatures,exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,BufferBuilder.prototype.append=function(a){"number"==typeof a?this._pieces.push(a):(this._flush(),this._parts.push(a))},BufferBuilder.prototype._flush=function(){if(this._pieces.length>0){var a=new Uint8Array(this._pieces);binaryFeatures.useArrayBufferView||(a=a.buffer),this._parts.push(a),this._pieces=[]}},BufferBuilder.prototype.getBuffer=function(){if(this._flush(),binaryFeatures.useBlobBuilder){for(var a=new BlobBuilder,b=0,c=this._parts.length;c>b;b++)a.append(this._parts[b]);return a.getBlob()}return new Blob(this._parts)},exports.BinaryPack={unpack:function(a){var b=new Unpacker(a);return b.unpack()},pack:function(a){var b=new Packer,c=b.pack(a);return c}},Unpacker.prototype.unpack=function(){var a=this.unpack_uint8();if(128>a){var b=a;return b}if(32>(224^a)){var c=(224^a)-32;return c}var d;if((d=160^a)<=15)return this.unpack_raw(d);if((d=176^a)<=15)return this.unpack_string(d);if((d=144^a)<=15)return this.unpack_array(d);if((d=128^a)<=15)return this.unpack_map(d);switch(a){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return d=this.unpack_uint16(),this.unpack_string(d);case 217:return d=this.unpack_uint32(),this.unpack_string(d);case 218:return d=this.unpack_uint16(),this.unpack_raw(d);case 219:return d=this.unpack_uint32(),this.unpack_raw(d);case 220:return d=this.unpack_uint16(),this.unpack_array(d);case 221:return d=this.unpack_uint32(),this.unpack_array(d);case 222:return d=this.unpack_uint16(),this.unpack_map(d);case 223:return d=this.unpack_uint32(),this.unpack_map(d)}},Unpacker.prototype.unpack_uint8=function(){var a=255&this.dataView[this.index];return this.index++,a},Unpacker.prototype.unpack_uint16=function(){var a=this.read(2),b=256*(255&a[0])+(255&a[1]);return this.index+=2,b},Unpacker.prototype.unpack_uint32=function(){var a=this.read(4),b=256*(256*(256*a[0]+a[1])+a[2])+a[3];return this.index+=4,b},Unpacker.prototype.unpack_uint64=function(){var a=this.read(8),b=256*(256*(256*(256*(256*(256*(256*a[0]+a[1])+a[2])+a[3])+a[4])+a[5])+a[6])+a[7];return this.index+=8,b},Unpacker.prototype.unpack_int8=function(){var a=this.unpack_uint8();return 128>a?a:a-256},Unpacker.prototype.unpack_int16=function(){var a=this.unpack_uint16();return 32768>a?a:a-65536},Unpacker.prototype.unpack_int32=function(){var a=this.unpack_uint32();return a<Math.pow(2,31)?a:a-Math.pow(2,32)},Unpacker.prototype.unpack_int64=function(){var a=this.unpack_uint64();return a<Math.pow(2,63)?a:a-Math.pow(2,64)},Unpacker.prototype.unpack_raw=function(a){if(this.length<this.index+a)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+a+" "+this.length);var b=this.dataBuffer.slice(this.index,this.index+a);return this.index+=a,b},Unpacker.prototype.unpack_string=function(a){for(var b,c,d=this.read(a),e=0,f="";a>e;)b=d[e],128>b?(f+=String.fromCharCode(b),e++):32>(192^b)?(c=(192^b)<<6|63&d[e+1],f+=String.fromCharCode(c),e+=2):(c=(15&b)<<12|(63&d[e+1])<<6|63&d[e+2],f+=String.fromCharCode(c),e+=3);return this.index+=a,f},Unpacker.prototype.unpack_array=function(a){for(var b=new Array(a),c=0;a>c;c++)b[c]=this.unpack();return b},Unpacker.prototype.unpack_map=function(a){for(var b={},c=0;a>c;c++){var d=this.unpack(),e=this.unpack();b[d]=e}return b},Unpacker.prototype.unpack_float=function(){var a=this.unpack_uint32(),b=a>>31,c=(a>>23&255)-127,d=8388607&a|8388608;return(0==b?1:-1)*d*Math.pow(2,c-23)},Unpacker.prototype.unpack_double=function(){var a=this.unpack_uint32(),b=this.unpack_uint32(),c=a>>31,d=(a>>20&2047)-1023,e=1048575&a|1048576,f=e*Math.pow(2,d-20)+b*Math.pow(2,d-52);return(0==c?1:-1)*f},Unpacker.prototype.read=function(a){var b=this.index;if(b+a<=this.length)return this.dataView.subarray(b,b+a);throw new Error("BinaryPackFailure: read index out of range")},Packer.prototype.pack=function(a){var b=typeof a;if("string"==b)this.pack_string(a);else if("number"==b)Math.floor(a)===a?this.pack_integer(a):this.pack_double(a);else if("boolean"==b)a===!0?this.bufferBuilder.append(195):a===!1&&this.bufferBuilder.append(194);else if("undefined"==b)this.bufferBuilder.append(192);else{if("object"!=b)throw new Error('Type "'+b+'" not yet supported');if(null===a)this.bufferBuilder.append(192);else{var c=a.constructor;if(c==Array)this.pack_array(a);else if(c==Blob||c==File)this.pack_bin(a);else if(c==ArrayBuffer)this.pack_bin(binaryFeatures.useArrayBufferView?new Uint8Array(a):a);else if("BYTES_PER_ELEMENT"in a)this.pack_bin(binaryFeatures.useArrayBufferView?a:a.buffer);else if(c==Object)this.pack_object(a);else if(c==Date)this.pack_string(a.toString());else{if("function"!=typeof a.toBinaryPack)throw new Error('Type "'+c.toString()+'" not yet supported');this.bufferBuilder.append(a.toBinaryPack())}}}return this.bufferBuilder.getBuffer()},Packer.prototype.pack_bin=function(a){var b=a.length||a.byteLength||a.size;if(15>=b)this.pack_uint8(160+b);else if(65535>=b)this.bufferBuilder.append(218),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(b)}this.bufferBuilder.append(a)},Packer.prototype.pack_string=function(a){var b=a.length;if(15>=b)this.pack_uint8(176+b);else if(65535>=b)this.bufferBuilder.append(216),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(b)}this.bufferBuilder.append(a)},Packer.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(b)}for(var c=0;b>c;c++)this.pack(a[c])},Packer.prototype.pack_integer=function(a){if(a>=-32&&127>=a)this.bufferBuilder.append(255&a);else if(a>=0&&255>=a)this.bufferBuilder.append(204),this.pack_uint8(a);else if(a>=-128&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(a>=0&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(a>=-32768&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(a>=0&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(a>=-2147483648&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(a>=-0x8000000000000000&&0x8000000000000000>=a)this.bufferBuilder.append(211),this.pack_int64(a);else{if(!(a>=0&&0x10000000000000000>=a))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(a)}},Packer.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var c=Math.floor(Math.log(a)/Math.LN2),d=a/Math.pow(2,c)-1,e=Math.floor(d*Math.pow(2,52)),f=Math.pow(2,32),g=b<<31|c+1023<<20|e/f&1048575,h=e%f;this.bufferBuilder.append(203),this.pack_int32(g),this.pack_int32(h)},Packer.prototype.pack_object=function(a){var b=Object.keys(a),c=b.length;if(15>=c)this.pack_uint8(128+c);else if(65535>=c)this.bufferBuilder.append(222),this.pack_uint16(c);else{if(!(4294967295>=c))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(c)}for(var d in a)a.hasOwnProperty(d)&&(this.pack(d),this.pack(a[d]))},Packer.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)},Packer.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8),this.bufferBuilder.append(255&a)},Packer.prototype.pack_uint32=function(a){var b=4294967295&a;this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b)},Packer.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)},Packer.prototype.pack_int8=function(a){this.bufferBuilder.append(255&a)},Packer.prototype.pack_int16=function(a){this.bufferBuilder.append((65280&a)>>8),this.bufferBuilder.append(255&a)},Packer.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255),this.bufferBuilder.append((16711680&a)>>>16),this.bufferBuilder.append((65280&a)>>>8),this.bufferBuilder.append(255&a)},Packer.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32)),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)};var isArray=Array.isArray;EventEmitter.prototype.addListener=function(a,b){if("function"!=typeof b)throw new Error("addListener only takes instances of Function");return this.emit("newListener",a,"function"==typeof b.listener?b.listener:b),this._events[a]?isArray(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(a,b){function c(){d.removeListener(a,c),b.apply(this,arguments)}if("function"!=typeof b)throw new Error(".once only takes instances of Function");var d=this;return c.listener=b,d.on(a,c),this},EventEmitter.prototype.removeListener=function(a,b){if("function"!=typeof b)throw new Error("removeListener only takes instances of Function");if(!this._events[a])return this;var c=this._events[a];if(isArray(c)){for(var d=-1,e=0,f=c.length;f>e;e++)if(c[e]===b||c[e].listener&&c[e].listener===b){d=e;break}if(0>d)return this;c.splice(d,1),0==c.length&&delete this._events[a]}else(c===b||c.listener&&c.listener===b)&&delete this._events[a];return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(a){return 0===arguments.length?(this._events={},this):(a&&this._events&&this._events[a]&&(this._events[a]=null),this)},EventEmitter.prototype.listeners=function(a){return this._events[a]||(this._events[a]=[]),isArray(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},EventEmitter.prototype.emit=function(a){var a=arguments[0],b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];b.apply(this,d)}return!0}if(isArray(b)){for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];for(var f=b.slice(),e=0,c=f.length;c>e;e++)f[e].apply(this,d);return!0}return!1},Reliable.prototype.send=function(a){var b=util.pack(a);return b.size<this._mtu?void this._handleSend(["no",b]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(b)},util.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},Reliable.prototype._setupInterval=function(){var a=this;this._timeout=setInterval(function(){var b=a._queue.shift();if(b._multiple)for(var c=0,d=b.length;d>c;c+=1)a._intervalSend(b[c]);else a._intervalSend(b)},this._interval)},Reliable.prototype._intervalSend=function(a){var b=this;a=util.pack(a),util.blobToBinaryString(a,function(a){b._dc.send(a)}),0===b._queue.length&&(clearTimeout(b._timeout),b._timeout=null)},Reliable.prototype._processAcks=function(){for(var a in this._outgoing)this._outgoing.hasOwnProperty(a)&&this._sendWindowedChunks(a)},Reliable.prototype._handleSend=function(a){for(var b=!0,c=0,d=this._queue.length;d>c;c+=1){var e=this._queue[c];e===a?b=!1:e._multiple&&-1!==e.indexOf(a)&&(b=!1)}b&&(this._queue.push(a),this._timeout||this._setupInterval())},Reliable.prototype._setupDC=function(){var a=this;this._dc.onmessage=function(b){var c=b.data,d=c.constructor;if(d===String){var e=util.binaryStringToArrayBuffer(c);c=util.unpack(e),a._handleMessage(c)}}},Reliable.prototype._handleMessage=function(a){var b,c=a[1],d=this._incoming[c],e=this._outgoing[c];switch(a[0]){case"no":var f=c;f&&this.onmessage(util.unpack(f));break;case"end":if(b=d,this._received[c]=a[2],!b)break;this._ack(c);break;case"ack":if(b=e){var g=a[2];b.ack=Math.max(g,b.ack),b.ack>=b.chunks.length?(util.log("Time: ",new Date-b.timer),delete this._outgoing[c]):this._processAcks()}break;case"chunk":if(b=d,!b){var h=this._received[c];if(h===!0)break;b={ack:["ack",c,0],chunks:[]},this._incoming[c]=b}var i=a[2],j=a[3];b.chunks[i]=new Uint8Array(j),i===b.ack[2]&&this._calculateNextAck(c),this._ack(c);break;default:this._handleSend(a)}},Reliable.prototype._chunk=function(a){for(var b=[],c=a.size,d=0;c>d;){var e=Math.min(c,d+this._mtu),f=a.slice(d,e),g={payload:f};b.push(g),d=e}return util.log("Created",b.length,"chunks."),b},Reliable.prototype._ack=function(a){var b=this._incoming[a].ack;this._received[a]===b[2]&&(this._complete(a),this._received[a]=!0),this._handleSend(b)},Reliable.prototype._calculateNextAck=function(a){for(var b=this._incoming[a],c=b.chunks,d=0,e=c.length;e>d;d+=1)if(void 0===c[d])return void(b.ack[2]=d);b.ack[2]=c.length},Reliable.prototype._sendWindowedChunks=function(a){util.log("sendWindowedChunks for: ",a);for(var b=this._outgoing[a],c=b.chunks,d=[],e=Math.min(b.ack+this._window,c.length),f=b.ack;e>f;f+=1)c[f].sent&&f!==b.ack||(c[f].sent=!0,d.push(["chunk",a,f,c[f].payload]));b.ack+this._window>=c.length&&d.push(["end",a,c.length]),d._multiple=!0,this._handleSend(d)},Reliable.prototype._complete=function(a){util.log("Completed called for",a);var b=this,c=this._incoming[a].chunks,d=new Blob(c);util.blobToArrayBuffer(d,function(a){b.onmessage(util.unpack(a))}),delete this._incoming[a]},Reliable.higherBandwidthSDP=function(a){var b=navigator.appVersion.match(/Chrome\/(.*?) /);if(b&&(b=parseInt(b[1].split(".").shift()),31>b)){var c=a.split("b=AS:30"),d="b=AS:102400";if(c.length>1)return c[0]+d+c[1]}return a},Reliable.prototype.onmessage=function(){},exports.Reliable=Reliable,exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate;var defaultConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]},dataCount=1,util={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(a){var b=parseInt(a,10);util.logLevel=isNaN(parseInt(a,10))?a?3:0:b,util.log=util.warn=util.error=util.noop,util.logLevel>0&&(util.error=util._printWith("ERROR")),util.logLevel>1&&(util.warn=util._printWith("WARNING")),util.logLevel>2&&(util.log=util._print)},setLogFunction:function(a){a.constructor!==Function?util.warn("The log function you passed in is not a function. Defaulting to regular logs."):util._print=a},_printWith:function(a){return function(){var b=Array.prototype.slice.call(arguments);b.unshift(a),util._print.apply(util,b)}},_print:function(){var a=!1,b=Array.prototype.slice.call(arguments);b.unshift("PeerJS: ");for(var c=0,d=b.length;d>c;c++)b[c]instanceof Error&&(b[c]="("+b[c].name+") "+b[c].message,a=!0);a?console.error.apply(console,b):console.log.apply(console,b)},defaultConfig:defaultConfig,browser:function(){return window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof RTCPeerConnection)return{};var a,b,c=!0,d=!0,e=!1,f=!1,g=!!window.webkitRTCPeerConnection;try{a=new RTCPeerConnection(defaultConfig,{optional:[{RtpDataChannels:!0}]})}catch(h){c=!1,d=!1}if(c)try{b=a.createDataChannel("_PEERJSTEST")}catch(h){c=!1}if(c){try{b.binaryType="blob",e=!0}catch(h){}var i=new RTCPeerConnection(defaultConfig,{});try{var j=i.createDataChannel("_PEERJSRELIABLETEST",{});f=j.reliable}catch(h){}i.close()}if(d&&(d=!!a.addStream),!g&&c){var k=new RTCPeerConnection(defaultConfig,{optional:[{RtpDataChannels:!0}]});k.onnegotiationneeded=function(){g=!0,util&&util.supports&&(util.supports.onnegotiationneeded=!0)};{k.createDataChannel("_PEERJSNEGOTIATIONTEST")}setTimeout(function(){k.close()},1e3)}return a&&a.close(),{audioVideo:d,data:c,binaryBlob:e,binary:f,reliable:f,sctp:f,onnegotiationneeded:g}}(),validateId:function(a){return!a||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(a)},validateKey:function(a){return!a||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(a)},debug:!1,inherits:function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(util.debug){var a=!1,b=Array.prototype.slice.call(arguments);b.unshift("PeerJS: ");for(var c=0,d=b.length;d>c;c++)b[c]instanceof Error&&(b[c]="("+b[c].name+") "+b[c].message,a=!0);a?console.error.apply(console,b):console.log.apply(console,b)}},setZeroTimeout:function(a){function b(b){d.push(b),a.postMessage(e,"*")}function c(b){b.source==a&&b.data==e&&(b.stopPropagation&&b.stopPropagation(),d.length&&d.shift()())}var d=[],e="zero-timeout-message";return a.addEventListener?a.addEventListener("message",c,!0):a.attachEvent&&a.attachEvent("onmessage",c),b}(this),chunk:function(a){for(var b=[],c=a.size,d=index=0,e=Math.ceil(c/util.chunkedMTU);c>d;){var f=Math.min(c,d+util.chunkedMTU),g=a.slice(d,f),h={__peerData:dataCount,n:index,data:g,total:e};b.push(h),d=f,index+=1}return dataCount+=1,b},blobToArrayBuffer:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsArrayBuffer(a)},blobToBinaryString:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsBinaryString(a)},binaryStringToArrayBuffer:function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=255&a.charCodeAt(c);return b.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};exports.util=util,util.inherits(Peer,EventEmitter),Peer.prototype._initializeServerConnection=function(){var a=this;this.socket=new Socket(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(b){a._handleMessage(b)}),this.socket.on("error",function(b){a._abort("socket-error",b)}),this.socket.on("disconnected",function(){a.disconnected||(a.emitError("network","Lost connection to server."),a.disconnect())}),this.socket.on("close",function(){a.disconnected||a._abort("socket-closed","Underlying socket is already closed.")})},Peer.prototype._retrieveId=function(){var a=this,b=new XMLHttpRequest,c=this.options.secure?"https://":"http://",d=c+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id",e="?ts="+(new Date).getTime()+Math.random();d+=e,b.open("get",d,!0),b.onerror=function(b){util.error("Error retrieving ID",b);var c="";"/"===a.options.path&&a.options.host!==util.CLOUD_HOST&&(c=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),a._abort("server-error","Could not get an ID from the server."+c)},b.onreadystatechange=function(){return 4===b.readyState?200!==b.status?void b.onerror():void a._initialize(b.responseText):void 0},b.send(null)},Peer.prototype._initialize=function(a){this.id=a,this.socket.start(this.id,this.options.token)},Peer.prototype._handleMessage=function(a){var b=a.type,c=a.payload,d=a.src;switch(b){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",c.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":util.log("Received leave message from",d),this._cleanupPeer(d);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+d);break;case"OFFER":var e=c.connectionId,f=this.getConnection(d,e);if(f)util.warn("Offer received for existing Connection ID:",e);else{if("media"===c.type){var f=new MediaConnection(d,this,{connectionId:e,_payload:c,metadata:c.metadata});this._addConnection(d,f),this.emit("call",f)}else{if("data"!==c.type)return void util.warn("Received malformed connection type:",c.type);f=new DataConnection(d,this,{connectionId:e,_payload:c,metadata:c.metadata,label:c.label,serialization:c.serialization,reliable:c.reliable}),this._addConnection(d,f),this.emit("connection",f)}for(var g=this._getMessages(e),h=0,i=g.length;i>h;h+=1)f.handleMessage(g[h])}break;default:if(!c)return void util.warn("You received a malformed message from "+d+" of type "+b);var j=c.connectionId,f=this.getConnection(d,j);f&&f.pc?f.handleMessage(a):j?this._storeMessage(j,a):util.warn("You received an unrecognized message:",a)}},Peer.prototype._storeMessage=function(a,b){this._lostMessages[a]||(this._lostMessages[a]=[]),this._lostMessages[a].push(b)},Peer.prototype._getMessages=function(a){var b=this._lostMessages[a];return b?(delete this._lostMessages[a],b):[]},Peer.prototype.connect=function(a,b){if(this.disconnected)return util.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var c=new DataConnection(a,this,b);return this._addConnection(a,c),c},Peer.prototype.call=function(a,b,c){if(this.disconnected)return util.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(!b)return void util.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");c=c||{},c._stream=b;var d=new MediaConnection(a,this,c);return this._addConnection(a,d),d},Peer.prototype._addConnection=function(a,b){this.connections[a]||(this.connections[a]=[]),this.connections[a].push(b)},Peer.prototype.getConnection=function(a,b){var c=this.connections[a];if(!c)return null;for(var d=0,e=c.length;e>d;d++)if(c[d].id===b)return c[d];return null},Peer.prototype._delayedAbort=function(a,b){var c=this;util.setZeroTimeout(function(){c._abort(a,b)})},Peer.prototype._abort=function(a,b){util.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(a,b)},Peer.prototype.emitError=function(a,b){util.error("Error:",b),"string"==typeof b&&(b=new Error(b)),b.type=a,this.emit("error",b)},Peer.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},Peer.prototype._cleanup=function(){if(this.connections)for(var a=Object.keys(this.connections),b=0,c=a.length;c>b;b++)this._cleanupPeer(a[b]);this.emit("close")},Peer.prototype._cleanupPeer=function(a){for(var b=this.connections[a],c=0,d=b.length;d>c;c+=1)b[c].close()},Peer.prototype.disconnect=function(){var a=this;util.setZeroTimeout(function(){a.disconnected||(a.disconnected=!0,a.open=!1,a.socket&&a.socket.close(),a.emit("disconnected",a.id),a._lastServerId=a.id,a.id=null)})},Peer.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)util.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");util.error("In a hurry? We're still trying to make the initial connection!")}},Peer.prototype.listAllPeers=function(a){a=a||function(){};var b=this,c=new XMLHttpRequest,d=this.options.secure?"https://":"http://",e=d+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers",f="?ts="+(new Date).getTime()+Math.random();e+=f,c.open("get",e,!0),c.onerror=function(){b._abort("server-error","Could not get peers from the server."),a([])},c.onreadystatechange=function(){if(4===c.readyState){if(401===c.status){var d="";throw d=b.options.host!==util.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+d)}a(200!==c.status?[]:JSON.parse(c.responseText))}},c.send(null)},exports.Peer=Peer,util.inherits(DataConnection,EventEmitter),DataConnection._idPrefix="dc_",DataConnection.prototype.initialize=function(a){this._dc=this.dataChannel=a,this._configureDataChannel()},DataConnection.prototype._configureDataChannel=function(){var a=this;util.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){util.log("Data channel connection success"),a.open=!0,a.emit("open")},!util.supports.sctp&&this.reliable&&(this._reliable=new Reliable(this._dc,util.debug)),this._reliable?this._reliable.onmessage=function(b){a.emit("data",b)}:this._dc.onmessage=function(b){a._handleDataMessage(b)},this._dc.onclose=function(){util.log("DataChannel closed for:",a.peer),a.close()}},DataConnection.prototype._handleDataMessage=function(a){var b=this,c=a.data,d=c.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(d===Blob)return void util.blobToArrayBuffer(c,function(a){c=util.unpack(a),b.emit("data",c)});if(d===ArrayBuffer)c=util.unpack(c);else if(d===String){var e=util.binaryStringToArrayBuffer(c);c=util.unpack(e)}}else"json"===this.serialization&&(c=JSON.parse(c));if(c.__peerData){var f=c.__peerData,g=this._chunkedData[f]||{data:[],count:0,total:c.total};return g.data[c.n]=c.data,g.count+=1,g.total===g.count&&(delete this._chunkedData[f],c=new Blob(g.data),this._handleDataMessage({data:c})),void(this._chunkedData[f]=g)}this.emit("data",c)},DataConnection.prototype.close=function(){this.open&&(this.open=!1,Negotiator.cleanup(this),this.emit("close"))},DataConnection.prototype.send=function(a,b){if(!this.open)return void this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));if(this._reliable)return void this._reliable.send(a);var c=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(a));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var d=util.pack(a),e=util.chunkedBrowsers[this._peerBrowser]||util.chunkedBrowsers[util.browser];if(e&&!b&&d.size>util.chunkedMTU)return void this._sendChunks(d);util.supports.sctp?util.supports.binaryBlob?this._bufferedSend(d):util.blobToArrayBuffer(d,function(a){c._bufferedSend(a)}):util.blobToBinaryString(d,function(a){c._bufferedSend(a)})}else this._bufferedSend(a)},DataConnection.prototype._bufferedSend=function(a){(this._buffering||!this._trySend(a))&&(this._buffer.push(a),this.bufferSize=this._buffer.length)},DataConnection.prototype._trySend=function(a){try{this._dc.send(a)}catch(b){this._buffering=!0;var c=this;return setTimeout(function(){c._buffering=!1,c._tryBuffer()},100),!1}return!0},DataConnection.prototype._tryBuffer=function(){if(0!==this._buffer.length){var a=this._buffer[0];this._trySend(a)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())
}},DataConnection.prototype._sendChunks=function(a){for(var b=util.chunk(a),c=0,d=b.length;d>c;c+=1){var a=b[c];this.send(a,!0)}},DataConnection.prototype.handleMessage=function(a){var b=a.payload;switch(a.type){case"ANSWER":this._peerBrowser=b.browser,Negotiator.handleSDP(a.type,this,b.sdp);break;case"CANDIDATE":Negotiator.handleCandidate(this,b.candidate);break;default:util.warn("Unrecognized message type:",a.type,"from peer:",this.peer)}},util.inherits(MediaConnection,EventEmitter),MediaConnection._idPrefix="mc_",MediaConnection.prototype.addStream=function(a){util.log("Receiving stream",a),this.remoteStream=a,this.emit("stream",a)},MediaConnection.prototype.handleMessage=function(a){var b=a.payload;switch(a.type){case"ANSWER":Negotiator.handleSDP(a.type,this,b.sdp),this.open=!0;break;case"CANDIDATE":Negotiator.handleCandidate(this,b.candidate);break;default:util.warn("Unrecognized message type:",a.type,"from peer:",this.peer)}},MediaConnection.prototype.answer=function(a){if(this.localStream)return void util.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");this.options._payload._stream=a,this.localStream=a,Negotiator.startConnection(this,this.options._payload);for(var b=this.provider._getMessages(this.id),c=0,d=b.length;d>c;c+=1)this.handleMessage(b[c]);this.open=!0},MediaConnection.prototype.close=function(){this.open&&(this.open=!1,Negotiator.cleanup(this),this.emit("close"))};var Negotiator={pcs:{data:{},media:{}},queue:[]};Negotiator._idPrefix="pc_",Negotiator.startConnection=function(a,b){var c=Negotiator._getPeerConnection(a,b);if("media"===a.type&&b._stream&&c.addStream(b._stream),a.pc=a.peerConnection=c,b.originator){if("data"===a.type){var d={};util.supports.sctp||(d={reliable:b.reliable});var e=c.createDataChannel(a.label,d);a.initialize(e)}util.supports.onnegotiationneeded||Negotiator._makeOffer(a)}else Negotiator.handleSDP("OFFER",a,b.sdp)},Negotiator._getPeerConnection=function(a,b){Negotiator.pcs[a.type]||util.error(a.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),Negotiator.pcs[a.type][a.peer]||(Negotiator.pcs[a.type][a.peer]={});{var c;Negotiator.pcs[a.type][a.peer]}return b.pc&&(c=Negotiator.pcs[a.type][a.peer][b.pc]),c&&"stable"===c.signalingState||(c=Negotiator._startPeerConnection(a)),c},Negotiator._startPeerConnection=function(a){util.log("Creating RTCPeerConnection.");var b=Negotiator._idPrefix+util.randomToken(),c={};"data"!==a.type||util.supports.sctp?"media"===a.type&&(c={optional:[{DtlsSrtpKeyAgreement:!0}]}):c={optional:[{RtpDataChannels:!0}]};var d=new RTCPeerConnection(a.provider.options.config,c);return Negotiator.pcs[a.type][a.peer][b]=d,Negotiator._setupListeners(a,d,b),d},Negotiator._setupListeners=function(a,b){var c=a.peer,d=a.id,e=a.provider;util.log("Listening for ICE candidates."),b.onicecandidate=function(b){b.candidate&&(util.log("Received ICE candidates for:",a.peer),e.socket.send({type:"CANDIDATE",payload:{candidate:b.candidate,type:a.type,connectionId:a.id},dst:c}))},b.oniceconnectionstatechange=function(){switch(b.iceConnectionState){case"disconnected":case"failed":util.log("iceConnectionState is disconnected, closing connections to "+c),a.close();break;case"completed":b.onicecandidate=util.noop}},b.onicechange=b.oniceconnectionstatechange,util.log("Listening for `negotiationneeded`"),b.onnegotiationneeded=function(){util.log("`negotiationneeded` triggered"),"stable"==b.signalingState?Negotiator._makeOffer(a):util.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},util.log("Listening for data channel"),b.ondatachannel=function(a){util.log("Received data channel");var b=a.channel,f=e.getConnection(c,d);f.initialize(b)},util.log("Listening for remote stream"),b.onaddstream=function(a){util.log("Received remote stream");var b=a.stream;e.getConnection(c,d).addStream(b)}},Negotiator.cleanup=function(a){util.log("Cleaning up PeerConnection to "+a.peer);var b=a.pc;!b||"closed"===b.readyState&&"closed"===b.signalingState||(b.close(),a.pc=null)},Negotiator._makeOffer=function(a){var b=a.pc;b.createOffer(function(c){util.log("Created offer."),!util.supports.sctp&&"data"===a.type&&a.reliable&&(c.sdp=Reliable.higherBandwidthSDP(c.sdp)),b.setLocalDescription(c,function(){util.log("Set localDescription: offer","for:",a.peer),a.provider.socket.send({type:"OFFER",payload:{sdp:c,type:a.type,label:a.label,connectionId:a.id,reliable:a.reliable,serialization:a.serialization,metadata:a.metadata,browser:util.browser},dst:a.peer})},function(b){a.provider.emitError("webrtc",b),util.log("Failed to setLocalDescription, ",b)})},function(b){a.provider.emitError("webrtc",b),util.log("Failed to createOffer, ",b)},a.options.constraints)},Negotiator._makeAnswer=function(a){var b=a.pc;b.createAnswer(function(c){util.log("Created answer."),!util.supports.sctp&&"data"===a.type&&a.reliable&&(c.sdp=Reliable.higherBandwidthSDP(c.sdp)),b.setLocalDescription(c,function(){util.log("Set localDescription: answer","for:",a.peer),a.provider.socket.send({type:"ANSWER",payload:{sdp:c,type:a.type,connectionId:a.id,browser:util.browser},dst:a.peer})},function(b){a.provider.emitError("webrtc",b),util.log("Failed to setLocalDescription, ",b)})},function(b){a.provider.emitError("webrtc",b),util.log("Failed to create answer, ",b)})},Negotiator.handleSDP=function(a,b,c){c=new RTCSessionDescription(c);var d=b.pc;util.log("Setting remote description",c),d.setRemoteDescription(c,function(){util.log("Set remoteDescription:",a,"for:",b.peer),"OFFER"===a&&Negotiator._makeAnswer(b)},function(a){b.provider.emitError("webrtc",a),util.log("Failed to setRemoteDescription, ",a)})},Negotiator.handleCandidate=function(a,b){var c=b.candidate,d=b.sdpMLineIndex;a.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:d,candidate:c})),util.log("Added ICE candidate for:",a.peer)},util.inherits(Socket,EventEmitter),Socket.prototype.start=function(a,b){this.id=a,this._httpUrl+="/"+a+"/"+b,this._wsUrl+="&id="+a+"&token="+b,this._startXhrStream(),this._startWebSocket()},Socket.prototype._startWebSocket=function(){var a=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(b){try{var c=JSON.parse(b.data);a.emit("message",c)}catch(d){return void util.log("Invalid server message",b.data)}},this._socket.onclose=function(){util.log("Socket closed."),a.disconnected=!0,a.emit("disconnected")},this._socket.onopen=function(){a._timeout&&(clearTimeout(a._timeout),setTimeout(function(){a._http.abort(),a._http=null},5e3)),a._sendQueuedMessages(),util.log("Socket open")})},Socket.prototype._startXhrStream=function(a){try{var b=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=a||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):this.readyState>2&&200===this.status&&this.responseText?b._handleStream(this):200!==this.status&&(clearTimeout(b._timeout),b.emit("disconnected"))},this._http.send(null),this._setHTTPTimeout()}catch(c){util.log("XMLHttpRequest not available; defaulting to WebSockets")}},Socket.prototype._handleStream=function(a){var b=a.responseText.split("\n");if(a._buffer)for(;a._buffer.length>0;){var c=a._buffer.shift(),d=b[c];try{d=JSON.parse(d)}catch(e){a._buffer.shift(c);break}this.emit("message",d)}var f=b[a._index];if(f)if(a._index+=1,a._index===b.length)a._buffer||(a._buffer=[]),a._buffer.push(a._index-1);else{try{f=JSON.parse(f)}catch(e){return void util.log("Invalid server message",f)}this.emit("message",f)}},Socket.prototype._setHTTPTimeout=function(){var a=this;this._timeout=setTimeout(function(){var b=a._http;a._wsOpen()?b.abort():(a._startXhrStream(b._streamIndex+1),a._http.old=b)},25e3)},Socket.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},Socket.prototype._sendQueuedMessages=function(){for(var a=0,b=this._queue.length;b>a;a+=1)this.send(this._queue[a])},Socket.prototype.send=function(a){if(!this.disconnected){if(!this.id)return void this._queue.push(a);if(!a.type)return void this.emit("error","Invalid message");var b=JSON.stringify(a);if(this._wsOpen())this._socket.send(b);else{var c=new XMLHttpRequest,d=this._httpUrl+"/"+a.type.toLowerCase();c.open("post",d,!0),c.setRequestHeader("Content-Type","application/json"),c.send(b)}}},Socket.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)};